<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Intern Panel</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ‚úÖ Section Switch */
    .pageSection {
      display: none;
    }

    .pageSection.active {
      display: block;
    }

    .miniGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .progressBar {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.10);
      margin-top: 10px;
    }

    .progressFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, var(--p1), var(--p3));
      box-shadow: 0 0 25px rgba(124, 0, 255, 0.25);
      transition: 0.4s;
    }

    .tableWrap table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .tableWrap th {
      text-align: left;
      padding: 12px 10px;
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .tableWrap td {
      padding: 14px 10px;
      vertical-align: middle;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .tableWrap tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .tableWrap td b {
      font-weight: 600;
    }

    .tableWrap td .btn {
      margin-top: 6px;
      display: inline-block;
    }

    .tableWrap td a {
      display: inline-block;
      margin-top: 6px;
      font-size: 13px;
      text-decoration: none;
      color: #8c7dff;
    }

    .tableWrap td a:hover {
      text-decoration: underline;
    }

    .tableWrap th:nth-child(1),
    .tableWrap td:nth-child(1) {
      width: 15%;
    }

    .tableWrap th:nth-child(2),
    .tableWrap td:nth-child(2) {
      width: 40%;
    }

    .tableWrap th:nth-child(3),
    .tableWrap td:nth-child(3) {
      width: 20%;
    }

    .tableWrap th:nth-child(4),
    .tableWrap td:nth-child(4) {
      width: 25%;
    }
    .achievementCard {
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  background: rgba(255,255,255,0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: 0.3s;
}

.achievementCard:hover {
  transform: scale(1.02);
}

.locked {
  opacity: 0.4;
}
.heatmapGrid {
  display: grid;
  grid-template-columns: repeat(18, 1fr);
  gap: 8px;
  margin-top: 20px;
}

.heatCell {
  height: 22px;
  border-radius: 6px;
  background: #1e1e1e;
  cursor: pointer;
  transition: 0.25s;
}

.heatCell:hover {
  transform: scale(1.2);
  box-shadow: 0 0 10px rgba(57,211,83,0.6);
}

.level4 {
  background: #39d353;
}

@media (max-width: 1000px) {
  /* 1. Shell Fix: Taaki scroll aur layers barobar rahein */
  .appShell {
    display: block !important;
    position: relative !important;
    min-height: 100vh;
    background: #05050A !important; /* Poora background dark */
  }

  /* 2. Topbar: Isse compact aur solid rakha hai */
  .topbar {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 10px 15px !important;
    min-height: 70px !important;
    background: #110f1a !important; /* Solid color, NO Transparency */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky !important;
    top: 0;
    z-index: 1000 !important; /* Sections ke upar rahega */
    margin-bottom: 10px !important;
  }

  /* 3. Hamburger Button: Left Side */
  .mobileMenuBtn {
    display: flex !important;
    width: 42px !important;
    height: 42px !important;
    background: #7c00ff !important;
    border-radius: 10px !important;
    justify-content: center;
    align-items: center;
    color: white;
    z-index: 1100;
  }

  /* 4. Text Sections: Isse hide kiya taaki overlap na ho */
  .titleWrap, .titleWrap p {
    display: none !important; 
  }

  /* 5. Refresh/Logout Buttons: Right Side Stacked */
  .actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;
    align-items: flex-end !important;
  }

  .actions .btn {
    width: 80px !important;
    padding: 4px 0 !important;
    font-size: 10px !important;
    margin: 0 !important;
    justify-content: center;
  }

  /* 6. Sidebar: Sabse Top Layer */
  .sidebar {
    position: fixed !important;
    left: -100% !important;
    top: 0;
    bottom: 0;
    width: 280px !important;
    height: 100vh !important;
    z-index: 999999 !important; /* Highest layer */
    background: #0d0b1a !important; /* Solid dark */
    box-shadow: 20px 0 50px rgba(0,0,0,0.9);
    transition: 0.3s ease-in-out;
    padding: 20px !important;
    display: block !important;
  }

  .sidebar.show {
    left: 0 !important;
  }

  /* 7. Main Content & Sections: Topbar ke niche stack honge */
  .main {
    padding: 0 10px !important;
    width: 100% !important;
    position: relative !important;
    z-index: 1 !important;
  }

  .card {
    background: #161425 !important; /* Solid card background, no transparency */
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    margin-bottom: 15px !important;
    padding: 15px !important;
    border-radius: 15px !important;
  }

  /* 8. Modal Fix: Overlap se bachne ke liye */
  .modalOverlay {
    z-index: 2000000 !important; /* Sidebar se bhi upar */
    background: rgba(0,0,0,0.85) !important;
  }

  .modalCard {
    width: 90% !important;
    background: #1a182b !important;
  }

  /* Tables Fix */
  .tableWrap {
    overflow-x: auto !important;
    background: rgba(255,255,255,0.02);
    border-radius: 10px;
  }


  /* ////////////////// */

  /* 1. Modal Close Button: Fixed Layout & No Shadows */
  .modalCard .btn.danger {
    background: #d95d56 !important;
    color: white !important;
    border: none !important;
    
    /* Shadows ko puri tarah khatam kiya */
    box-shadow: none !important;
    text-shadow: none !important;
    outline: none !important;
    
    /* Responsive Width Logic */
    width: 100% !important; /* Mobile par full width better lagti hai */
    max-width: 300px !important; /* Lekin 300px se zyada bada nahi hoga */
    min-width: unset !important; /* Purani min-width ko reset kiya */
    
    padding: 14px !important;
    font-weight: 700 !important;
    font-size: 15px !important;
    border-radius: 12px !important;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .modalCard .btn.danger:active {
    background: #b84a44 !important; /* Click karne par thoda dark feedback */
  }

  /* 2. Topbar Buttons: Clean & Flat */
  .actions .btn {
    box-shadow: none !important;
    text-shadow: none !important;
    background: rgba(255, 255, 255, 0.05) !important; /* Halki solid feel */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 8px !important;
    color: white !important;
  }

  /* 3. Hamburger Button (‚ò∞): No Shadow & High Visibility */
  .mobileMenuBtn {
    box-shadow: none !important;
    text-shadow: none !important;
    background: #7c00ff !important; /* Branded color */
    border: none !important;
    color: white !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }

}

  </style>

</head>

<body>
  <div class="container">
    <div class="appShell">

      <!-- ‚úÖ SIDEBAR -->
      <aside class="sidebar">
        <div class="sideTop">
          <div class="brandBox">
            <div class="brandLogo">
              <img src="logo.png" alt="COD Logo">
            </div>
            <div class="brandText">
              <h3>COD PANEL</h3>
              <p>Intern Dashboard</p>
            </div>
          </div>

          <div class="rolePill" id="internPill">INT</div>
        </div>

        <div class="nav" id="internNav">
          <a class="active" href="javascript:void(0)" onclick="switchPage('todayPage', this)">üìå Today‚Äôs Task</a>
          <a href="javascript:void(0)" onclick="switchPage('historyPage', this)">üìö Task History</a>
          <a href="javascript:void(0)" onclick="switchPage('submitPage', this)">üì§ Submit Task</a>
          <a href="javascript:void(0)" onclick="switchPage('performancePage', this)">üèÜ Performance</a>
          <a href="javascript:void(0)" onclick="switchPage('messagesPage', this)">üí¨ Messages</a>
          <a href="javascript:void(0)" onclick="switchPage('profilePage', this)">üë§ Profile</a>
        </div>

        <div class="sideFooter">
          ‚úÖ Submit GitHub/Deploy link<br />
          ‚úÖ Grade by Admin<br />
          ‚úÖ Full History Safe
        </div>
      </aside>

      <!-- ‚úÖ MAIN -->
      <main class="main">

        <!-- ‚úÖ TOPBAR -->
        <div class="topbar">
          <button class="btn ghost mobileMenuBtn" onclick="toggleSidebar()">‚ò∞</button>
          <div class="titleWrap">
            <h1>üë®‚Äçüíª Intern Panel</h1>
            <p id="internInfo">Loading...</p>
          </div>
          <div class="actions">
            <button class="btn ghost" onclick="init()">üîÑ Refresh</button>
            <button class="btn danger" onclick="logout()">Logout</button>
          </div>
        </div>

        <!-- ‚úÖ 1) TODAY -->
        <section class="card pageSection active" id="todayPage">
          <div class="cardHead">
            <div>
              <h2>üìå Today‚Äôs Task</h2>
              <span id="todayMeta">Loading...</span>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>TaskID</th>
                  <th>Task</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="todayTable"></tbody>
            </table>
          </div>

          <div class="small">
            ‚úÖ Your Tasks Will Show Here.
          </div>
        </section>

        <!-- ‚úÖ 2) HISTORY -->
        <section class="card pageSection" id="historyPage">
          <div class="cardHead">
            <div>
              <h2>üìö Task History</h2>
              <span>Pending/Completed + Grade</span>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Grade</th>
                </tr>
              </thead>
              <tbody id="historyTable"></tbody>
            </table>
          </div>

          <div class="small">
            ‚úÖ If the grade is not given, ‚ÄúNote Seen‚Äù will be shown.
          </div>
        </section>

        <!-- ‚úÖ 3) SUBMIT TASK -->
        <section class="card pageSection" id="submitPage">
          <div class="cardHead">
            <div>
              <h2>üì§ Submit Task</h2>
              <span>Task auto select (Today tasks)</span>
            </div>
          </div>

          <label>Select Today Task</label>
          <select id="submitTaskSelect"></select>

          <label>Submission Link (GitHub / Deploy)</label>
          <input id="submitLink" placeholder="https://github.com/..." />

          <label>Details (optional)</label>
          <textarea id="submitDetails" placeholder="What you did today..."></textarea>

          <button class="btn primary" onclick="submitTask()">Submit</button>

          <div class="small">
            ‚úÖ Editing allowed for 5 minutes after submission.
          </div>

          <label style="margin-top:14px;">Edit Submissi on ID (Within 5 mins)</label>
          <input id="editSubmissionId" placeholder="SUB0001" />
          <button class="btn" onclick="editSubmission()">Edit Submission</button>
        </section>

        
        <section class="card pageSection" id="performancePage">
          <div class="cardHead">
            <div>
              <h2>üèÜ Performance Dashboard</h2>
              <span>6 Month Based Achievements</span>
            </div>
          </div>

          <div class="miniGrid">

            <!-- LEFT SIDE -->
            <div>
              <h3>üéÆ Achievements</h3>
              <div id="achievementBox"></div>
            </div>

            <!-- RIGHT SIDE -->
            <div>
              <h3>üìÖ Activity Map</h3>
              <div id="heatmap" class="heatmapGrid"></div>
            </div>

          </div>
        </section>




        <!-- ‚úÖ 6) MESSAGES -->
        <section class="card pageSection" id="messagesPage">
          <div class="cardHead">
            <div>
              <h2>üí¨ Messages</h2>
              <span>Admin ‚Üî Intern </span>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" onclick="loadMyChat()">üîÑ Refresh</button>
              <button class="btn danger" onclick="internClearChat()">üßπ Clear Chat</button>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Sender</th>
                  <th>Message</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="internChatTable"></tbody>
            </table>
          </div>

          <label style="margin-top:12px;">Send Message to Admin</label>
          <input id="internChatMsg" placeholder="Type message..." />
          <button class="btn primary" onclick="internSendMsg()">Send</button>

          <div class="small">
            ‚úÖ The message will be automatically deleted within 48 hours.
          </div>
        </section>


        <!-- ‚úÖ 7) PROFILE -->
        <section class="card pageSection" id="profilePage">
          <div class="cardHead">
            <div>
              <h2>üë§ Profile</h2>
              <span>Change Password</span>
            </div>
          </div>

          <label>Old Password</label>
          <input id="oldPass" type="password" placeholder="Old password" />

          <label>New Password</label>
          <input id="newPass" type="password" placeholder="New password" />

          <button class="btn primary" onclick="changePassword()">Change Password</button>
        </section>

        <div id="taskModal" class="modalOverlay">
  <div class="modalCard" style="display: flex; flex-direction: column;">
    <div style="display:flex; justify-content:space-between; align-items: center;">
      <h3 id="modalTaskTitle" style="font-size: 16px; margin: 0;"></h3>
      </div>

    <div style="margin-top:15px; color:var(--muted); font-size: 14px;" id="modalTaskDesc"></div>

    <div style="display: flex; justify-content: flex-end;">
       <button class="btn danger" onclick="closeTaskModal()">Close</button>
    </div>
  </div>
</div>


      </main>
    </div>
  </div>

  <!-- Loader + Toast -->
  <div id="loaderOverlay" class="loaderOverlay">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div id="loaderText">Loading...</div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script src="app.js"></script>

  <script>


    const visitedInternPages = {
      todayPage: false,
      historyPage: false,
      submitPage: false,
      progressPage: false,
      streakPage: false,
      messagesPage: false,
      profilePage: false
    };


    const intern = getSession("intern");
    if (!intern) window.location.href = "index.html";

    document.getElementById("internPill").innerText = intern.InternID;
    document.getElementById("internInfo").innerText =
      `Welcome, ${intern.Name} ‚Ä¢ Batch: ${intern.Batch} ‚Ä¢ Duration: ${intern.Duration}`;

    // ‚úÖ Switch page
    async function switchPage(pageId, navEl) {

      document.querySelectorAll(".pageSection")
        .forEach(s => s.classList.remove("active"));

      document.getElementById(pageId)
        .classList.add("active");

      document.querySelectorAll("#internNav a")
        .forEach(a => a.classList.remove("active"));

      navEl.classList.add("active");

      // üî• IMPORTANT: Reload tasks when needed

      if (pageId === "todayPage") {
        await loadToday();
      }

      if (pageId === "submitPage") {
        await loadToday();  // <-- THIS FIXES DROPDOWN
      }

      if (pageId === "historyPage") {
        await loadHistory();
      }
      if(pageId === "performancePage") {
    await loadPerformance();
      }

    }


    function pill(status) {
      const s = (status || "").toLowerCase();
      if (s.includes("approved")) return `<span class="pill ok">${status}</span>`;
      if (s.includes("rejected")) return `<span class="pill bad">${status}</span>`;
      if (s.includes("submitted") || s.includes("pending")) return `<span class="pill warn">${status}</span>`;
      return `<span class="pill">${status || "-"}</span>`;
    }

    async function loadToday(silent = false) {

      showLoader(true, "Loading Pending Tasks...", silent);

      const data = await apiGET({
        action: "getInternPendingTasks",
        internId: intern.InternID
      });

      showLoader(false, "", silent);

      if (!data.success) {
        toast(data.message, "error");
        return;
      }

      const tasks = data.tasks || [];

      // üî• Meta Text
      document.getElementById("todayMeta").innerText =
        "All Pending Tasks (Old + Today)";

      // ===============================
      // ‚úÖ TABLE RENDER
      // ===============================
      const tb = document.getElementById("todayTable");
      tb.innerHTML = "";

      if (tasks.length === 0) {
        tb.innerHTML = `
      <tr>
        <td colspan="3">No pending tasks ‚úÖ</td>
      </tr>
    `;
      } else {

        tasks.forEach(t => {

  const safeTitle = (t.Title || "").replace(/'/g, "");
  const safeDesc  = (t.Description || "").replace(/'/g, "");
  const link      = t.SubmissionLink || "";

  tb.innerHTML += `
    <tr>
      <td><b>${t.AssignedTaskID}</b></td>

      <td>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-weight:600;">${safeTitle}</div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">

            <button class="btn ghost"
              onclick="openTaskModal('${t.AssignedTaskID}','${safeTitle}','${safeDesc}')">
              üîò Open
            </button>

            ${link ? `
              <a href="${link}" target="_blank" class="btn ghost">
                üîó Open Submission
              </a>
            ` : ""}

          </div>
        </div>
      </td>

      <td>${pill(t.Status || "Pending")}</td>
    </tr>
  `;
});

      }

      // ===============================
      // ‚úÖ SUBMIT DROPDOWN RENDER
      // ===============================
      const sel = document.getElementById("submitTaskSelect");

      if (tasks.length === 0) {

        sel.innerHTML = `
      <option value="">No pending task</option>
    `;

      } else {

        sel.innerHTML = `
      <option value="">Select Pending Task</option>
      ${tasks.map(t => `
        <option value="${t.AssignedTaskID}">
          ${t.Title} (${t.AssignedTaskID})
        </option>
      `).join("")}
    `;
      }
    }


    function openTaskModal(id, title, desc) {
      document.getElementById("modalTaskTitle").innerText =
        id + " - " + title;

      document.getElementById("modalTaskDesc").innerText =
        desc || "No Description";

      document.getElementById("taskModal")
        .classList.add("show");
    }

    function closeTaskModal() {
      document.getElementById("taskModal")
        .classList.remove("show");
    }


    async function loadHistory(silent = false) {
      showLoader(true, "Loading History...", silent);
      const data = await apiGET({ action: "getInternHistory", internId: intern.InternID });
      showLoader(false, "", silent);

      if (!data.success) { toast(data.message, "error"); return; }

      const tb = document.getElementById("historyTable");
      tb.innerHTML = "";

      if ((data.history || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="4">No history ‚úÖ</td></tr>`;
        return;
      }
      data.history.slice(0, 50).forEach(h => {

        const safeTitle = (h.Title || "").replace(/`/g, "");
        const safeDesc = (h.Description || "").replace(/`/g, "");
        const link = h.SubmissionLink || "";

        tb.innerHTML += `
    <tr>
      <td>${h.Date || "-"}</td>

      <td>
        <b>${safeTitle}</b><br/>

        <button class="btn ghost"
          onclick="openTaskModal(
            '${h.AssignedTaskID || ""}',
            \`${safeTitle}\`,
            \`${safeDesc}\`
          )">
          üîò Open
        </button>

        ${link ? `
          <br/>
          <a href="${link}" target="_blank" class="btn ghost" style="margin-top:6px;">
            üîó Open Submission
          </a>
        ` : ""}
      </td>

      <td>${pill(h.Status || "Pending")}</td>

      <td><b>${h.Grade || "Not Seen"}</b></td>
    </tr>
  `;
      });

    }

    async function submitTask() {
      const assignedTaskId = document.getElementById("submitTaskSelect").value;
      const link = document.getElementById("submitLink").value.trim();
      const details = document.getElementById("submitDetails").value.trim();

      if (!assignedTaskId) { toast("Select task first ‚ùå", "error"); return; }
      if (!link) { toast("Submission link required ‚ùå", "error"); return; }

      showLoader(true, "Submitting...");
      const data = await apiPOST({
        action: "internSubmitTask",
        internId: intern.InternID,
        assignedTaskId,
        link,
        details
      });
      showLoader(false);

      if (data.success) {
        toast("Submitted ‚úÖ", "success");
        document.getElementById("editSubmissionId").value = data.submissionId;
        loadToday();
        loadHistory();
        loadProgress();
        loadStreak();
      } else toast(data.message, "error");
    }

    async function editSubmission() {
      const submissionId = document.getElementById("editSubmissionId").value.trim();
      const link = document.getElementById("submitLink").value.trim();
      const details = document.getElementById("submitDetails").value.trim();

      if (!submissionId) { toast("SubmissionID required ‚ùå", "error"); return; }

      showLoader(true, "Editing (5 min rule)...");
      const data = await apiPOST({
        action: "internEditSubmission",
        internId: intern.InternID,
        submissionId,
        link,
        details
      });
      showLoader(false);

      if (data.success) {
        toast("Edited ‚úÖ", "success");
        loadHistory();
      } else toast(data.message, "error");
    }

    async function loadProgress(silent = false) {
      const data = await apiGET({ action: "getInternPerformance", internId: intern.InternID });
      if (!data.success) return;

      const percent = data.percent || 0;
      document.getElementById("progressPercent").innerText = percent;
      document.getElementById("progressFill").style.width = percent + "%";
    }

    async function loadStreak(silent = false) {
      const data = await apiGET({ action: "getInternStreak", internId: intern.InternID });
      if (!data.success) return;
      document.getElementById("streakCount").innerText = data.streak || 0;
    }

    async function changePassword() {
      const oldPassword = document.getElementById("oldPass").value.trim();
      const newPassword = document.getElementById("newPass").value.trim();

      if (!oldPassword || !newPassword) {
        toast("Fill both passwords ‚ùå", "error"); return;
      }

      showLoader(true, "Changing Password...");
      const data = await apiPOST({
        action: "internChangePassword",
        internId: intern.InternID,
        oldPassword,
        newPassword
      });
      showLoader(false);

      if (data.success) {
        toast("Password Changed ‚úÖ", "success");
        document.getElementById("oldPass").value = "";
        document.getElementById("newPass").value = "";
      } else toast(data.message, "error");
    }

    async function init() {
      await loadToday();
      await loadHistory();
      await loadMyChat();
      await loadPerformance();
      


    }


    async function loadMyChat(silent = false) {
      showLoader(true, "Loading Messages...", silent);
      const data = await apiGET({
        action: "internGetChat",
        internId: intern.InternID
      });
      showLoader(false, "", silent);

      const tb = document.getElementById("internChatTable");
      tb.innerHTML = "";

      if (!data.success) {
        tb.innerHTML = `<tr><td colspan="3">${data.message}</td></tr>`;
        return;
      }

      if ((data.messages || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="3">No messages ‚úÖ</td></tr>`;
        return;
      }

      data.messages.forEach(m => {
        tb.innerHTML += `
      <tr>
        <td><b>${m.Sender}</b></td>
        <td>${m.Message}</td>
        <td>${m.CreatedAt}</td>
      </tr>
    `;
      });
    }

    async function internSendMsg() {
      const message = document.getElementById("internChatMsg").value.trim();
      if (!message) { toast("Message empty ‚ùå", "error"); return; }

      showLoader(true, "Sending...");
      const data = await apiGET({
        action: "sendMessageGET",
        internId: intern.InternID,
        sender: "Intern",
        message
      });
      showLoader(false);

      if (data.success) {
        toast("Sent ‚úÖ", "success");
        document.getElementById("internChatMsg").value = "";
        loadMyChat();
      } else toast(data.message, "error");
    }


    async function internClearChat() {
      showLoader(true, "Clearing Chat...");
      const data = await apiGET({
        action: "clearChatGET",
        internId: intern.InternID,
        by: "Intern"
      });
      showLoader(false);

      if (data.success) {
        toast("Chat cleared ‚úÖ", "success");
        loadMyChat();
      } else toast(data.message, "error");
    }

    let INTERN_AUTO_TIMER = null;

    function startAutoRefreshIntern() {
      if (INTERN_AUTO_TIMER) clearInterval(INTERN_AUTO_TIMER);

      INTERN_AUTO_TIMER = setInterval(async () => {
        if (document.hidden) return;

        const activePage = document.querySelector(".pageSection.active")?.id || "";

        if (activePage === "todayPage") await loadToday(true);
        if (activePage === "historyPage") await loadHistory(true);
        if (activePage === "messagesPage") await loadMyChat(true);
        

      }, 5000);
    }

    async function loadInterns(silent = false) {
      showLoader(true, "Loading Students...", silent);

      const batchId = document.getElementById("filterBatch").value;
      const sort = document.getElementById("sortType").value;

      const data = await apiGET({
        action: "getInternsList",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        batchId,
        sort
      });

      showLoader(false, "", silent);

      if (!data.success) {
        if (!silent) toast(data.message, "error"); // ‚úÖ silent me toast bhi nahi
        return;
      }

      // ‚úÖ update UI normally (no loader)
      const tb = document.getElementById("internTable");
      tb.innerHTML = "";

    }

    async function loadPerformance(){

  const data = await apiGET({
    action: "getInternPerformance",
    internId: intern.InternID
  });

  if(!data.success) return;

  renderAchievements(
    data.percent,
    data.submissionCount
  );

  renderHeatmap(
    data.activityMap,
    data.createdAt,
    data.highestStreak
  );
}






function renderAchievements(percent, totalApproved){

  totalApproved = parseInt(totalApproved);
  if (isNaN(totalApproved)) totalApproved = 0;

  const levels = [
    { name: "ü•â Bronze", minSub: 4 },
    { name: "ü•à Silver", minSub: 8 },
    { name: "ü•á Gold", minSub: 12 },
    { name: "üíé Platinum", minSub: 16 },
    { name: "üî∑ Diamond", minSub: 20 },
    { name: "üëë Master", minSub: 30 }
  ];

  const box = document.getElementById("achievementBox");
  box.innerHTML = "";

  levels.forEach(level => {

    const unlocked = totalApproved >= level.minSub;
    const remaining = Math.max(level.minSub - totalApproved, 0);

    box.innerHTML += `
      <div class="achievementCard ${unlocked ? "" : "locked"}">
        <div>
          <div style="font-weight:600;">${level.name}</div>
          <div style="font-size:12px;">
            ${unlocked 
              ? "Unlocked ‚úÖ"
              : `Need ${remaining} more submissions`
            }
          </div>
        </div>
        <div style="font-weight:600;">
          ${totalApproved}/${level.minSub}
        </div>
      </div>
    `;
  });

  box.innerHTML += `
    <div style="
        margin-top:15px;
        padding:12px;
        border-radius:10px;
        background:rgba(255,255,255,0.05);
        font-size:14px;
    ">
      <div><b>Total Approved:</b> ${totalApproved}</div>
      <div><b>Performance Score:</b> ${percent}%</div>
    </div>
  `;
}




function renderHeatmap(activityMap, createdAt, highestStreak){

  const grid = document.getElementById("heatmap");
  grid.innerHTML = "";

  if(!createdAt) return;

  const startDate = new Date(createdAt);
  if(isNaN(startDate)) return;

  const today = new Date();
  const totalDays = 180;

  for(let i=0;i<totalDays;i++){

    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);

    if(d > today) break;

    const formatted = d.getFullYear() + "-" +
      String(d.getMonth()+1).padStart(2,"0") + "-" +
      String(d.getDate()).padStart(2,"0");

    const dayLabel = d.toLocaleDateString("en-US", {
      weekday:"long",
      year:"numeric",
      month:"long",
      day:"numeric"
    });

    let className = "heatCell";
    let clickHandler = "";

    if(activityMap[formatted]){
      className += " level4";
      const tasks = JSON.stringify(activityMap[formatted]);
      clickHandler = `onclick='openDayTasks(${tasks})'`;
    }

    grid.innerHTML += `
      <div class="${className}" ${clickHandler}
           title="${dayLabel}">
      </div>
    `;
  }

  grid.innerHTML += `
    <div style="grid-column: span 18; margin-top:15px;">
      üî• Highest Streak: <b>${highestStreak} days</b>
    </div>
  `;
}


function openDayTasks(tasks){

  let content = "";

  tasks.forEach(t => {
    content += `
      <div style="margin-bottom:10px;">
        <b>${t.taskId}</b><br/>
        ${t.link ? `<a href="${t.link}" target="_blank">Open Submission</a>` : ""}
      </div>
    `;
  });

  document.getElementById("modalTaskTitle").innerText = "Tasks Completed";
  document.getElementById("modalTaskDesc").innerHTML = content;

  document.getElementById("taskModal").classList.add("show");
}
// ‚úÖ Sidebar dikhane ya chhupane ka logic
// ‚úÖ Ye function sidebar toggle karega
// Sidebar toggle logic
// ‚úÖ 1. Sidebar ko Open/Close karne wala function
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        sidebar.classList.toggle('show');
    }
}

// ‚úÖ 2. Sections Switch karne wala logic (Isme Sidebar Auto-Close add kiya hai)
async function switchPage(pageId, navEl) {
    // Saare sections hide karo
    document.querySelectorAll(".pageSection").forEach(s => s.classList.remove("active"));
    
    // Chuninda section dikhao
    const target = document.getElementById(pageId);
    if (target) target.classList.add("active");

    // Nav links highlight fix
    document.querySelectorAll(".nav a").forEach(a => a.classList.remove("active"));
    if (navEl) navEl.classList.add("active");

    // üî• MOBILE FIX: Section badalte hi sidebar apne aap band ho jaye
    if (window.innerWidth <= 1000) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.remove('show');
    }

    // Aapke purane data load functions yahan call hote rahenge
    if (pageId === "todayPage") await loadToday();
    if (pageId === "historyPage") await loadHistory();
    if (pageId === "performancePage") await loadPerformance();
    if (pageId === "messagesPage") await loadMyChat();
}

// ‚úÖ 3. Sidebar ke bahar click karne par band karne ka option (Best for Mobile)
document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const menuBtn = document.querySelector('.mobileMenuBtn');
    if (sidebar && sidebar.classList.contains('show')) {
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
            sidebar.classList.remove('show');
        }
    }
});
    init();
    startAutoRefreshIntern();

  </script>
</body>

</html>