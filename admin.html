<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ‚úÖ Section Switch */
    .pageSection {
      display: none;
    }

    .pageSection.active {
      display: block;
    }

    /* ‚úÖ small top heading inside each page */
    .pageTop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .pageTop h2 {
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 0.4px;
    }

    .pageTop p {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* ‚úÖ 3 dot button */
    .dotBtn {
      padding: 8px 12px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      cursor: pointer;
    }

    .dotBtn:hover {
      background: rgba(255, 255, 255, 0.06);
      box-shadow: 0 0 25px rgba(124, 0, 255, 0.12);
      transform: translateY(-1px);
      transition: 0.2s;
    }

    /* ‚úÖ Modal */
    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }

    .modalOverlay.show {
      display: flex;
    }

    .modalCard {
      width: min(1150px, 96vw);
      max-height: 90vh;
      overflow: auto;
      border-radius: 22px;
      border: 1px solid rgba(124, 0, 255, 0.25);
      background: rgba(10, 8, 18, 0.96);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .card canvas {
      max-height: 220px;
    }
    /* ===============================
   Intern Hover Tooltip
================================ */

.internCell{
  position: relative;
  cursor: pointer;
}

.internTooltip{
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) scale(0.9);
  
  background: linear-gradient(135deg, #7C00FF, #B100FF);
  color: #fff;
  
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  
  white-space: nowrap;
  
  opacity: 0;
  pointer-events: none;
  transition: 0.25s;
  
  box-shadow: 0 8px 25px rgba(124,0,255,0.35);
  z-index: 100;
}

/* arrow */
.internTooltip::after{
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  
  border-width: 6px;
  border-style: solid;
  border-color: #7C00FF transparent transparent transparent;
}

.internCell:hover .internTooltip{
  opacity: 1;
  transform: translateX(-50%) scale(1);
}

  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body>
  <div class="container">
    <div class="appShell">

      <!-- ‚úÖ SIDEBAR -->
      <aside class="sidebar">

        <div class="sideTop">
          <div class="brandBox">
            <div class="brandLogo">
              <img src="logo.png" alt="COD Logo">
            </div>
            <div class="brandText">
              <h3>COD PANEL</h3>
              <p>Admin Control</p>
            </div>
          </div>

          <div class="rolePill" id="adminPill">Admin</div>
        </div>

        <!-- ‚úÖ MENU -->
        <div class="nav" id="adminNav">
          <a class="active" href="javascript:void(0)" onclick="switchPage('studentsPage', this)">üë®‚Äçüéì Students</a>
          <a href="javascript:void(0)" onclick="switchPage('batchPage', this)">üß© Batch + Intern Create</a>
          <a href="javascript:void(0)" onclick="switchPage('assignPage', this)">üìå Assign Task</a>
          <a href="javascript:void(0)" onclick="switchPage('subsPage', this)">‚úÖ Submissions</a>
          <a href="javascript:void(0)" onclick="switchPage('incompletePage', this)">‚ö†Ô∏è Incomplete</a>
          <a href="javascript:void(0)" onclick="switchPage('analyticsPage', this)">üìä Analytics</a>


        </div>

        <div class="sideFooter">
          ‚úÖ Max 20 interns per batch<br />
          ‚úÖ Batch + Individual task<br />
          ‚úÖ Grade + remarks<br />
          ‚úÖ Full tracking
        </div>

      </aside>

      <!-- ‚úÖ MAIN -->
      <main class="main">

        <!-- ‚úÖ TOPBAR (Always visible) -->
        <div class="topbar">
          <div class="titleWrap">
            <h1>‚ö°CODELINE.AI</h1>
            <p>Software training institute in Maharashtra</p>
          </div>

          <div class="actions">
            <button class="btn ghost" onclick="init()">üîÑ Refresh</button>
            <button class="btn danger" onclick="logout()">Logout</button>
          </div>
        </div>

        <!-- ‚úÖ PAGE 1: STUDENTS -->
        <section class="card pageSection active" id="studentsPage">
          <div class="pageTop">
            <div>
              <h2>üë®‚Äçüéì All Students List</h2>
              <!-- <p>Batch-wise filter + A-Z sorting + 3 dot details view</p> -->
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" onclick="loadInterns()">Load</button>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Batch Filter</label>
              <select id="filterBatch"></select>
            </div>
            <div>
              <label>Sort</label>
              <select id="sortType">
                <option value="">Default</option>
                <option value="A-Z">A-Z</option>
              </select>
            </div>
          </div>

          <div class="tableWrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>InternID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Batch</th>
                  <th>Duration</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="internTable"></tbody>
            </table>
          </div>

          <!-- <div class="small">‚úÖ ‚Äú‚ãÆ‚Äù click ‚Üí full intern overview (history + submissions + streak)</div> -->
        </section>

        <!-- ‚úÖ PAGE 2: BATCH + INTERN CREATE -->
        <section class="card pageSection" id="batchPage">
          <div class="pageTop">
            <div>
              <h2>üß© Batch + Intern Create</h2>
              <p>Batch mandatory ‚Ä¢ Max 20 interns in 1 batch</p>
            </div>
          </div>

          <div class="grid2">

            <!-- Create Batch -->
            <div class="card">
              <div class="cardHead">
                <div>
                  <h2>üß© Create Batch</h2>
                  <!-- <span>Auto BatchID generate</span> -->
                </div>
              </div>

              <label>Batch Name</label>
              <input id="batchName" placeholder="BATCH-1 / JAN-2026" />

              <button class="btn primary" onclick="createBatch()">Create Batch</button>
              <div class="small" id="batchMsg"></div>
            </div>

            <!-- Create Intern -->
            <div class="card">
              <div class="cardHead">
                <div>
                  <h2>‚ûï Create Intern</h2>
                  <span>Intern ID will auto generate</span>
                </div>
              </div>

              <label>Name</label>
              <input id="inName" placeholder="Intern Name" />

              <label>Email</label>
              <input id="inEmail" placeholder="intern@gmail.com" />

              <label>Select Batch</label>
              <select id="inBatch"></select>

              <label>Duration</label>
              <select id="inDuration">
                <option>6 Months</option>
                <option>9 Months</option>
              </select>

              <button class="btn primary" onclick="createIntern()">Create Intern</button>
              <div class="small" id="createdInternText"></div>

              <div class="small">
                <!-- ‚úÖ Intern ko bolo: Index page me password set kare. -->
              </div>
            </div>

          </div>
        </section>

        <!-- ‚úÖ PAGE 3: ASSIGN TASK -->
        <section class="card pageSection" id="assignPage">
          <div class="pageTop">
            <div>
              <h2>üìå Assign Task</h2>
              <!-- <p>Option 1: Batch-wise ‚Ä¢ Option 2: Individual Task</p> -->
            </div>
          </div>

          <label>Date</label>
          <input id="taskDate" type="date" />

          <label>Task Title</label>
          <input id="taskTitle" placeholder="Day X: Task name" />

          <label>Description</label>
          <textarea id="taskDesc" placeholder="Write full task details..."></textarea>

          <div class="row2">

            <div>
              <label>Assign Batch-wise</label>
              <select id="assignBatch"></select>
              <button class="btn primary" onclick="assignBatchTask()">Assign Batch Task</button>
            </div>

            <div>
              <label>Assign Individual Intern</label>
              <input id="assignInternId" placeholder="INT0001" />
              <button class="btn" onclick="assignIndividualTask()">Assign Individual Task</button>
            </div>

          </div>

          <div class="small">
            <!-- ‚úÖ Individual task assign hote hi intern side ‚ÄúToday‚Äôs Task‚Äù me show hoga. -->
          </div>
        </section>

        <!-- ‚úÖ PAGE 4: SUBMISSIONS -->
        <section class="card pageSection" id="subsPage">
          <div class="pageTop">
            <div>
              <h2>‚úÖ Submissions</h2>
              <p>Pending submissions check + grade assign</p>
            </div>

            <button class="btn" onclick="loadSubmissions()">üîÑ Refresh</button>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>SubmissionID</th>
                  <th>TaskID</th>
                  <th>InternID</th>
                  <th>Link</th>
                  <th>Details</th>
                  <th>SubmittedAt</th>
                  <th>Grade</th>
                  <th>Remarks</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="subsTable"></tbody>
            </table>
          </div>

          <!-- <div class="small">‚úÖ Approve/Reject ke baad intern history update ho jayegi.</div> -->
        </section>

        <!-- ‚úÖ PAGE: INCOMPLETE STUDENTS -->
        <section class="card pageSection" id="incompletePage">
          <div class="pageTop">
            <div>
              <h2>‚ö†Ô∏è Incomplete Students</h2>
              <p>Those who did not submit today's task</p>
            </div>
            <button class="btn" onclick="loadIncomplete()">üîÑ Refresh</button>
          </div>

          <label>Date</label>
          <input id="incompleteDate" type="date" />

          <button class="btn primary" onclick="loadIncomplete()">Load Incomplete</button>

          <div class="tableWrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>InternID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Batch</th>
                  <th>Pending</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="incompleteTable"></tbody>
            </table>
          </div>

          <div class="small">
            ‚úÖ The message will be auto deleted in 48 hours.
          </div>
        </section>

        <section class="card pageSection" id="analyticsPage">

          <div class="pageTop">
            <div>
              <h2>üìä Analytics Dashboard</h2>
              <p>System insights and performance</p>
            </div>
            <button class="btn" onclick="loadAnalytics()">üîÑ Refresh</button>
          </div>

          <div class="kpis" style="grid-template-columns:repeat(7,1fr);">

            <div class="kpi"><b id="kTotal">0</b><small>Total Interns</small></div>
            <div class="kpi"><b id="kActive">0</b><small>Active</small></div>
            <div class="kpi"><b id="kPending">0</b><small>Pending</small></div>
            <div class="kpi"><b id="kApproved">0</b><small>Approved</small></div>
            <div class="kpi"><b id="kPercent">0%</b><small>Approval %</small></div>

            <!-- NEW -->
            <div class="kpi"><b id="kAvg">0</b><small>Average Grade</small></div>
            <div class="kpi"><b id="kDay">-</b><small>Most Active Day</small></div>

          </div>


          <div class="grid2" style="margin-top:18px;">

            <div class="card">
              <h3>Submission Status</h3>
              <canvas id="statusChart" height="220"></canvas>
            </div>

            <div class="card">
              <h3>Batch Performance %</h3>
              <canvas id="batchChart" height="220"></canvas>

            </div>

            <!-- NEW -->
            <div class="card">
              <h3>Submission Trend</h3>
              <canvas id="trendChart" height="220"></canvas>
            </div>

            <!-- NEW -->
            <div class="card">
              <h3>Top Interns</h3>
              <div id="topInternsBox"></div>
            </div>

          </div>


        </section>


        <!-- ‚úÖ CHAT MODAL (Admin ‚Üî Intern) -->
        <div id="chatModal" class="modalOverlay">
          <div class="modalCard">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
              <div>
                <div style="font-family:Orbitron,Inter;font-size:16px;font-weight:900;">üí¨ Chat</div>
                <div style="color:var(--muted);font-size:12px;margin-top:6px;" id="chatMeta">Loading...</div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn" onclick="adminClearChat()">üßπ Clear Chat</button>
                <button class="btn danger" onclick="closeChat()">Close</button>
              </div>
            </div>

            <div class="tableWrap" style="margin-top:14px;">
              <table>
                <thead>
                  <tr>
                    <th>Sender</th>
                    <th>Message</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="chatTable"></tbody>
              </table>
            </div>

            <label style="margin-top:12px;">Send Message</label>
            <input id="chatMsg" placeholder="Write message..." />
            <button class="btn primary" onclick="adminSendMsg()">Send</button>
          </div>
        </div>



      </main>
    </div>
  </div>

  <!-- ‚úÖ INTERN OVERVIEW MODAL -->
  <div id="internModal" class="modalOverlay">
    <div class="modalCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div>
          <div style="font-family:Orbitron,Inter;font-size:16px;font-weight:900;">
            üë®‚Äçüéì Intern Overview
          </div>
          <div style="color:var(--muted);font-size:12px;margin-top:6px;" id="modalMeta">
            Loading...
          </div>
        </div>

        <button class="btn danger" onclick="closeInternModal()">Close</button>
      </div>

      <div style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.10);padding-top:14px;">
        <div class="kpis" style="grid-template-columns:repeat(4,1fr);">
          <div class="kpi"><b id="mStreak">0</b><small>Streak</small></div>
          <div class="kpi"><b id="mTotalSub">0</b><small>Total Submissions</small></div>
          <div class="kpi"><b id="mPending">0</b><small>Pending</small></div>
          <div class="kpi"><b id="mApproved">0</b><small>Approved</small></div>
        </div>

        <div style="margin-top:14px;" class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Task</th>
                <th>Status</th>
                <th>Grade</th>
                <th>Submission</th>
              </tr>
            </thead>
            <tbody id="modalHistory"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Loader + Toast -->
  <div id="loaderOverlay" class="loaderOverlay">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div id="loaderText">Loading...</div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script src="app.js"></script>

  <script>

    const visitedAdminPages = {
      studentsPage: false,
      batchPage: false,
      assignPage: false,
      subsPage: false,
      incompletePage: false

    };


    const admin = getSession("admin");
    if (!admin) window.location.href = "index.html";

    // ‚úÖ Default date
    document.getElementById("taskDate").value = new Date().toISOString().slice(0, 10);

    // ‚úÖ Switch Page Function
    async function switchPage(pageId, navEl) {
      document.querySelectorAll(".pageSection").forEach(s => s.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");

      document.querySelectorAll("#adminNav a").forEach(a => a.classList.remove("active"));
      navEl.classList.add("active");

      // ‚úÖ FIRST VISIT = loader ON, next = silent
      const firstTime = !visitedAdminPages[pageId];
      visitedAdminPages[pageId] = true;

      // ‚úÖ Load data based on section
      if (pageId === "studentsPage") await loadInterns(!firstTime);
      if (pageId === "subsPage") await loadSubmissions(!firstTime);
      if (pageId === "incompletePage") await loadIncomplete(!firstTime);

      // ‚úÖ Batch page (optional)
      if (pageId === "batchPage") await loadBatches(!firstTime);

      // ‚úÖ Assign page (optional - only batches reload)
      if (pageId === "assignPage") await loadBatches(!firstTime);
      if (pageId === "analyticsPage") await loadAnalytics(!firstTime);

    }


    // ‚úÖ Init
    async function init() {
      await loadBatches();
      await loadInterns();
      await loadSubmissions();
    }

    async function loadBatches(silent = false) {
      showLoader(true, "Loading Batches...", silent);
      const data = await apiGET({
        action: "getBatches",
        adminId: admin.adminId,
        adminPass: admin.adminPass
      });
      showLoader(false, "", silent);

      if (!data.success) { toast(data.message, "error"); return; }

      const list = data.batches || [];

      document.getElementById("filterBatch").innerHTML =
        `<option value="">All</option>` +
        list.map(b => `<option value="${b.BatchID}">${b.BatchName} (${b.BatchID})</option>`).join("");

      document.getElementById("inBatch").innerHTML =
        list.map(b => `<option value="${b.BatchID}">${b.BatchName} (${b.BatchID})</option>`).join("");

      document.getElementById("assignBatch").innerHTML =
        list.map(b => `<option value="${b.BatchID}">${b.BatchName} (${b.BatchID})</option>`).join("");
    }

    async function createBatch() {
      showLoader(true, "Creating Batch...");
      const batchName = document.getElementById("batchName").value.trim();

      const data = await apiPOST({
        action: "adminCreateBatch",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        batchName
      });
      showLoader(false);

      if (data.success) {
        toast("Batch Created ‚úÖ", "success");
        document.getElementById("batchMsg").innerHTML = `‚úÖ Created: <b>${data.batchName}</b> (${data.batchId})`;
        document.getElementById("batchName").value = "";
        loadBatches();
      } else toast(data.message, "error");
    }

    async function createIntern() {
      showLoader(true, "Creating Intern...");
      const name = document.getElementById("inName").value.trim();
      const email = document.getElementById("inEmail").value.trim();
      const batchId = document.getElementById("inBatch").value;
      const duration = document.getElementById("inDuration").value;

      const data = await apiGET({
        action: "adminCreateInternGET",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        name, email, batchId, duration
      });

      showLoader(false);

      if (data.success) {
        toast("Intern Created ‚úÖ", "success");
        document.getElementById("createdInternText").innerHTML =
          `‚úÖ InternID: <b>${data.internId}</b> | Batch: <b>${data.batchName}</b>`;
        loadInterns();
      } else toast(data.message, "error");
    }



    async function assignBatchTask() {
      showLoader(true, "Assigning Batch Task...");
      const date = document.getElementById("taskDate").value;
      const batchId = document.getElementById("assignBatch").value;
      const title = document.getElementById("taskTitle").value.trim();
      const description = document.getElementById("taskDesc").value.trim();

      const data = await apiPOST({
        action: "adminAssignBatchTask",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        date, batchId, title, description
      });
      showLoader(false);

      if (data.success) toast("Batch Task Assigned ‚úÖ", "success");
      else toast(data.message, "error");
    }

    async function assignIndividualTask() {
      showLoader(true, "Assigning Individual Task...");
      const date = document.getElementById("taskDate").value;
      const internId = document.getElementById("assignInternId").value.trim();
      const title = document.getElementById("taskTitle").value.trim();
      const description = document.getElementById("taskDesc").value.trim();

      const data = await apiPOST({
        action: "adminAssignIndividualTask",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        date, internId, title, description
      });
      showLoader(false);

      if (data.success) toast("Individual Task Assigned ‚úÖ", "success");
      else toast(data.message, "error");
    }

    async function loadSubmissions(silent = false) {
      showLoader(true, "Loading Submissions...", silent);
      const data = await apiGET({
        action: "getPendingSubmissions",
        adminId: admin.adminId,
        adminPass: admin.adminPass
      });
      showLoader(false, "", silent);
      if (!data.success) { toast(data.message, "error"); return; }

      const tb = document.getElementById("subsTable");
      tb.innerHTML = "";

      if ((data.submissions || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="9">No pending submissions ‚úÖ</td></tr>`;
        return;
      }

      data.submissions.forEach(s => {
        tb.innerHTML += `
          <tr>
            <td>${s.SubmissionID}</td>
            <td>${s.AssignedTaskID}</td>
           <td class="internCell">
             <b>${s.InternID}</b>
             <span class="internTooltip">${s.Name}</span>
          </td>

            <td><a href="${s.Link}" target="_blank" style="color:var(--p3);font-weight:900;">Open</a></td>
            <td>${s.Details || "-"}</td>
            <td>${s.SubmittedAt}</td>
            <td><input id="g_${s.SubmissionID}" placeholder="A / 10"/></td>
            <td><input id="r_${s.SubmissionID}" placeholder="remarks"/></td>
            <td style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn primary" onclick="grade('${s.SubmissionID}','Approved')">Approve</button>
              <button class="btn danger" onclick="grade('${s.SubmissionID}','Rejected')">Reject</button>
            </td>
          </tr>
        `;
      });
    }

    async function grade(submissionId, finalStatus) {
      showLoader(true, "Saving Grade...");
      const grade = document.getElementById("g_" + submissionId).value.trim();
      const remarks = document.getElementById("r_" + submissionId).value.trim();

      const data = await apiPOST({
        action: "adminGradeSubmission",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        submissionId,
        finalStatus,
        grade,
        remarks
      });
      showLoader(false);

      if (data.success) {
        toast("Graded ‚úÖ", "success");
        loadSubmissions();
      } else toast(data.message, "error");
    }

    // ‚úÖ Intern Overview Modal (Requires backend GET adminInternOverview)
    function closeInternModal() {
      document.getElementById("internModal").classList.remove("show");
    }

    async function openInternOverview(internId) {
      document.getElementById("internModal").classList.add("show");
      document.getElementById("modalMeta").innerText = "Loading intern data...";
      document.getElementById("modalHistory").innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

      const data = await apiGET({
        action: "adminInternOverview",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        internId
      });

      if (!data.success) {
        toast(data.message, "error");
        closeInternModal();
        return;
      }

      const I = data.intern;
      document.getElementById("modalMeta").innerText =
        `ID: ${I.InternID} | Name: ${I.Name} | Email: ${I.Email} | Batch: ${I.BatchName} | Duration: ${I.Duration}`;

      document.getElementById("mStreak").innerText = data.streak || 0;
      document.getElementById("mTotalSub").innerText = data.submissions.total || 0;
      document.getElementById("mPending").innerText = data.submissions.pending.length || 0;
      document.getElementById("mApproved").innerText = data.submissions.approved.length || 0;

      const tb = document.getElementById("modalHistory");
      tb.innerHTML = "";

      const history = (data.history || []).slice(0, 50);

      if (history.length === 0) {
        tb.innerHTML = `<tr><td colspan="5">No history found ‚úÖ</td></tr>`;
        return;
      }

      history.forEach(h => {
        const subLink = h.SubmissionLink
          ? `<a href="${h.SubmissionLink}" target="_blank" style="color:var(--p3);font-weight:900;">Open</a>`
          : "-";

        tb.innerHTML += `
          <tr>
            <td>${h.Date}</td>
            <td>
              <b>${h.Title}</b><br/>
              <span style="color:var(--muted);font-size:12px;">${h.Description || ""}</span>
            </td>
            <td>${h.Status || "-"}</td>
            <td><b>${h.Grade || "Not Seen"}</b></td>
            <td>${subLink}</td>
          </tr>
        `;
      });
    }

    // ‚úÖ default date for incomplete
    document.getElementById("incompleteDate").value = new Date().toISOString().slice(0, 10);

    async function loadIncomplete(silent = false) {
      showLoader(true, "Loading Incomplete...", silent);
      const date = document.getElementById("incompleteDate").value;

      const data = await apiGET({
        action: "getIncompleteStudents",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        date
      });

      showLoader(false, "", silent);

      if (!data.success) { toast(data.message, "error"); return; }

      const tb = document.getElementById("incompleteTable");
      tb.innerHTML = "";

      if ((data.students || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="6">‚úÖ No incomplete students today</td></tr>`;
        return;
      }

      data.students.forEach(s => {
        tb.innerHTML += `
      <tr>
        <td><b>${s.InternID}</b></td>
        <td>${s.Name}</td>
        <td>${s.Email}</td>
        <td>${s.BatchName}</td>
        <td><b>${s.PendingTasks}</b></td>
        <td>
          <button class="btn" onclick="openChat('${s.InternID}','${s.Name}')">üí¨ Message</button>
        </td>
      </tr>
    `;
      });
    }

    // ‚úÖ Chat state
    let CURRENT_CHAT_INTERN = "";

    function closeChat() {
      document.getElementById("chatModal").classList.remove("show");
      CURRENT_CHAT_INTERN = "";
    }

    async function openChat(internId, name) {
      CURRENT_CHAT_INTERN = internId;
      document.getElementById("chatModal").classList.add("show");
      document.getElementById("chatMeta").innerText = `Intern: ${name} (${internId}) | Auto delete in 48h`;
      await loadChatMessages();
    }

    async function loadChatMessages(silent = false) {
      const data = await apiGET({
        action: "getChat",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        internId: CURRENT_CHAT_INTERN
      });

      const tb = document.getElementById("chatTable");
      tb.innerHTML = "";

      if (!data.success) {
        tb.innerHTML = `<tr><td colspan="3">${data.message}</td></tr>`;
        return;
      }

      if ((data.messages || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="3">No messages ‚úÖ</td></tr>`;
        return;
      }

      data.messages.forEach(m => {
        tb.innerHTML += `
      <tr>
        <td><b>${m.Sender}</b></td>
        <td>${m.Message}</td>
        <td>${m.CreatedAt}</td>
      </tr>
    `;
      });
    }

    async function adminSendMsg() {
      const message = document.getElementById("chatMsg").value.trim();
      if (!message) { toast("Message empty ‚ùå", "error"); return; }

      showLoader(true, "Sending message...");  // ‚úÖ manual => loader ON

      const data = await apiGET({
        action: "sendMessageGET",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        internId: CURRENT_CHAT_INTERN,
        sender: "Admin",
        message
      });

      showLoader(false); // ‚úÖ loader OFF

      if (data.success) {
        toast("Sent ‚úÖ", "success");
        document.getElementById("chatMsg").value = "";
        loadChatMessages(true); // ‚úÖ reload silently
      } else {
        toast(data.message, "error");
      }
    }


    async function adminClearChat() {
      showLoader(true, "Clearing Chat...");
      const data = await apiGET({
        action: "clearChatGET",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        internId: CURRENT_CHAT_INTERN,
        by: "Admin"
      });
      showLoader(false);

      if (data.success) {
        toast("Chat cleared ‚úÖ", "success");
        loadChatMessages();
      } else toast(data.message, "error");
    }


    let AUTO_REFRESH_TIMER = null;

    function startAutoRefreshAdmin() {
      if (AUTO_REFRESH_TIMER) clearInterval(AUTO_REFRESH_TIMER);

      AUTO_REFRESH_TIMER = setInterval(async () => {
        if (document.hidden) return;

        const activePage = document.querySelector(".pageSection.active")?.id || "";

        if (activePage === "studentsPage") await loadInterns(true);
        // if(activePage === "subsPage") await loadSubmissions(true);
        if (activePage === "incompletePage") await loadIncomplete(true);

        if (document.getElementById("chatModal")?.classList.contains("show")) {
          await loadChatMessages(true);
        }

      }, 4000); // ‚úÖ 4 sec smooth
    }

    async function loadInterns(silent = false) {
      showLoader(true, "Loading Students...", silent);

      const batchId = document.getElementById("filterBatch").value;
      const sort = document.getElementById("sortType").value;

      const data = await apiGET({
        action: "getInternsList",
        adminId: admin.adminId,
        adminPass: admin.adminPass,
        batchId,
        sort
      });

      showLoader(false, "", silent);

      if (!data.success) {
        if (!silent) toast(data.message, "error");
        return;
      }

      const tb = document.getElementById("internTable");
      tb.innerHTML = "";

      if ((data.interns || []).length === 0) {
        tb.innerHTML = `<tr><td colspan="6">No interns found ‚úÖ</td></tr>`;
        return;
      }

      data.interns.forEach(i => {
        tb.innerHTML += `
      <tr>
        <td><b>${i.InternID}</b></td>
        <td>${i.Name}</td>
        <td>${i.Email}</td>
        <td>${i.BatchName}</td>
        <td>${i.Duration}</td>
        <td><button class="dotBtn" onclick="openInternOverview('${i.InternID}')">‚ãÆ</button></td>
      </tr>
    `;
      });
    }

    let statusChart, batchChart;
    let trendChart;

    async function loadAnalytics() {

      showLoader(true, "Loading Analytics...");

      const data = await apiGET({
        action: "getAdminAnalytics",
        adminId: admin.adminId,
        adminPass: admin.adminPass
      });

      showLoader(false);

      if (!data.success) {
        toast(data.message, "error");
        return;
      }

      const k = data.kpis;

      document.getElementById("kTotal").innerText = k.totalInterns;
      document.getElementById("kActive").innerText = k.activeInterns;
      document.getElementById("kPending").innerText = k.pending;
      document.getElementById("kApproved").innerText = k.approved;
      document.getElementById("kPercent").innerText = k.approvalPercent + "%";
      document.getElementById("kAvg").innerText = k.avgGrade || 0;
      document.getElementById("kDay").innerText = k.mostActiveDay || "-";

      // ===== STATUS CHART =====
      const s = data.charts.status;

      if (statusChart) statusChart.destroy();

      statusChart = new Chart(
        document.getElementById("statusChart"),
        {
          type: "pie",
          data: {
            labels: s.labels,
            datasets: [{ data: s.data }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        }
      );


      // ===== BATCH CHART =====
      const b = data.charts.batch;

      if (batchChart) batchChart.destroy();

      batchChart = new Chart(
        document.getElementById("batchChart"),
        {
          type: "bar",
          data: {
            labels: b.labels,
            datasets: [{ data: b.data }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        }
      );


      // ===== TREND CHART =====
      const t = data.charts.trend;

      if (trendChart) trendChart.destroy();

      trendChart = new Chart(
        document.getElementById("trendChart"),
        {
          type: "line",
          data: {
            labels: t.labels,
            datasets: [{
              label: "Submissions",
              data: t.data
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        }
      );


    }



    init();
    startAutoRefreshAdmin();

  </script>
</body>

</html>